[gcode_shell_command CHAMBER_THERMAL_LOG]
command: python3 /home/scott/chamber_thermal_log.py
timeout: 120.0
verbose: True

[gcode_macro CHAMBER_THERMAL_CLEANUP]
description: "Safely stop chamber thermal test and turn off all heaters/fans"
gcode:
    M117 Stopping chamber thermal test...
    RESPOND PREFIX="TEST" MSG="Stopping chamber thermal test and cleaning up..."
    
    # Shut off exhaust fan, bed heater, nevermore, and part cooling fan
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET=0
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
    SET_FAN_SPEED FAN=nevermore SPEED=0
    M106 S0  # Turn off part cooling fan
    
    # Lift away from bed for safety
    G91
    G1 Z25 F600
    G90
    
    M117 Chamber thermal test stopped
    RESPOND PREFIX="TEST" MSG="Chamber thermal test stopped. All heaters and fans turned off."

[gcode_macro CHAMBER_THERMAL_CAPTURE]
description: "Capture tap zero position and log to chamber_thermal_log.py"
gcode:
    {% set T    = params.TEMP|float %}
    {% set TAP  = params.TAP|int %}
    {% set IGN  = params.IGNORE|default(0)|int %}

    # Use current toolhead Z (after PROBE) instead of last_z_result
    {% set z    = printer.toolhead.position.z|float %}
    {% set ZSTR = '%.5f'|format(z) %}

    {% if IGN %}
        RESPOND PREFIX="TEST" MSG="Chamber: T={T}C tap {TAP} (ignored) Z={ZSTR}"
    {% else %}
        RESPOND PREFIX="TEST" MSG="Chamber: T={T}C tap {TAP} Z={ZSTR}"
        {% set PARAM = "add_raw %0.1f %d %s" % (T, TAP, ZSTR) %}
        RUN_SHELL_COMMAND CMD=CHAMBER_THERMAL_LOG PARAMS="{PARAM}"
    {% endif %}



[gcode_macro TEST_CHAMBER_THERMAL]
description: "Measure chamber thermal expansion vs temperature using tap zero position"
gcode:
    {% set START = params.START|default(25)|int %}
    {% set END   = params.END|default(60)|int %}
    {% set STEP  = params.STEP|default(5)|int %}

    # Per-test Z lift settings (all relative moves)
    {% set TAP_LIFT     = params.TAP_LIFT|default(2.0)|float %}
    {% set INITIAL_LIFT = params.INITIAL_LIFT|default(5.0)|float %}
    {% set FINAL_LIFT   = params.FINAL_LIFT|default(25.0)|float %}

    # Compute bed center from axis_max/2
    {% set xmax = printer.toolhead.axis_maximum.x|float %}
    {% set ymax = printer.toolhead.axis_maximum.y|float %}
    {% set cx = xmax / 2.0 %}
    {% set cy = ymax / 2.0 %}

    M117 Chamber thermal test: starting
    RESPOND PREFIX="TEST" MSG="Starting chamber thermal test from {START}C to {END}C step {STEP}C"

    # Home and then lift up a bit *relative* to wherever homing left Z
    G28
    G91
    G1 Z{INITIAL_LIFT} F600
    G90

    # Move to bed center
    G1 X{cx} Y{cy} F6000

    # Cool the chamber before starting (turn off exhaust fan and bed)
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET=0
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
    SET_FAN_SPEED FAN=nevermore SPEED=0
    M106 S0  # Turn off part cooling fan
    # Wait for chamber to cool down to starting temperature
    TEMPERATURE_WAIT SENSOR="temperature_fan exhaust_fan" MAXIMUM={START + 2}

    # Start new CSV file
    RUN_SHELL_COMMAND CMD=CHAMBER_THERMAL_LOG PARAMS="init"

    # Take baseline measurement at starting temperature BEFORE heating begins
    RESPOND PREFIX="TEST" MSG="Taking baseline measurement at {START}C"
    M117 Baseline measurement: {START}C
    G4 P2000  # Brief pause for stability
    
    # Get actual chamber temperature
    {% set chamber_temp = printer["temperature_fan exhaust_fan"].temperature|float %}
    {% set chamber_temp_str = "%.1f"|format(chamber_temp) %}
    RESPOND PREFIX="TEST" MSG="Baseline measurement: actual chamber temp is {chamber_temp_str}C (expected ~{START}C)"
    
    # ---- Baseline Tap 1 (ignored) ----
    PROBE
    CHAMBER_THERMAL_CAPTURE TEMP={chamber_temp} TAP=1 IGNORE=1
    G91
    G1 Z{TAP_LIFT} F900
    G90

    # ---- Baseline Tap 2 ----
    PROBE
    CHAMBER_THERMAL_CAPTURE TEMP={chamber_temp} TAP=2 IGNORE=0
    G91
    G1 Z{TAP_LIFT} F900
    G90

    # ---- Baseline Tap 3 ----
    PROBE
    CHAMBER_THERMAL_CAPTURE TEMP={chamber_temp} TAP=3 IGNORE=0
    G91
    G1 Z{TAP_LIFT} F900
    G90

    # ---- Baseline Tap 4 ----
    PROBE
    CHAMBER_THERMAL_CAPTURE TEMP={chamber_temp} TAP=4 IGNORE=0
    G91
    G1 Z{TAP_LIFT} F900
    G90

    # Set up heating and fans for the test
    # Set bed to 110°C to warm the chamber
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=110
    # Turn on nevermore fan at 50% to circulate air
    SET_FAN_SPEED FAN=nevermore SPEED=0.5
    # Turn on part cooling fan at 50% (127/255 ≈ 50%) to circulate air
    M106 S127
    # Keep exhaust fan off so it doesn't cool the chamber
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET=0

    RESPOND PREFIX="TEST" MSG="Bed set to 110°C, nevermore at 50%, part cooling at 50%"

    # Main measurement loop - monitor chamber temperature as it warms
    # Start from START + STEP since we already measured START
    {% for T in range(START + STEP, END + 1, STEP) %}
        # Get current temp before waiting
        {% set current_temp = printer["temperature_fan exhaust_fan"].temperature|float %}
        {% set current_temp_str = "%.1f"|format(current_temp) %}
        RESPOND PREFIX="TEST" MSG="Current temp: {current_temp_str}C, waiting for chamber to reach {T}C"
        M117 Chamber thermal test: {T}C
        
        # Wait for chamber temperature to reach target (monitor exhaust_fan sensor)
        # Check current temp first
        {% set initial_wait_temp = printer["temperature_fan exhaust_fan"].temperature|float %}
        {% set initial_wait_temp_str = "%.1f"|format(initial_wait_temp) %}
        
        # If temp is already above target range, we've overshot - log and proceed
        {% if initial_wait_temp > T + 2 %}
            RESPOND PREFIX="TEST" MSG="WARNING: Temp {initial_wait_temp_str}C already above target {T}C. Chamber warming too fast."
        {% endif %}
        
        # Wait until temp is at least T-1 (ensures we're at or approaching target)
        TEMPERATURE_WAIT SENSOR="temperature_fan exhaust_fan" MINIMUM={T - 1}
        
        # Now wait until temp is within range (T-1 to T+2) or timeout
        # If temp exceeds T+2, we'll proceed anyway but log a warning
        TEMPERATURE_WAIT SENSOR="temperature_fan exhaust_fan" MINIMUM={T - 1} MAXIMUM={T + 3}
        
        # Get final temperature after wait
        {% set temp_after_wait = printer["temperature_fan exhaust_fan"].temperature|float %}
        {% set temp_after_wait_str = "%.1f"|format(temp_after_wait) %}
        RESPOND PREFIX="TEST" MSG="Temperature after wait: {temp_after_wait_str}C (target was {T}C, range {T - 1}-{T + 2}C)"

        G4 P3000

        # Get actual chamber temperature
        {% set chamber_temp = printer["temperature_fan exhaust_fan"].temperature|float %}
        
        # Verify we're actually at the target (warn if way off)
        {% if chamber_temp < T - 2 or chamber_temp > T + 2 %}
            {% set chamber_temp_str = "%.1f"|format(chamber_temp) %}
            RESPOND PREFIX="TEST" MSG="WARNING: Chamber temp {chamber_temp_str}C is outside expected range for target {T}C"
        {% endif %}

        # ---- Tap 1 (ignored) ----
        PROBE
        CHAMBER_THERMAL_CAPTURE TEMP={chamber_temp} TAP=1 IGNORE=1
        G91
        G1 Z{TAP_LIFT} F900
        G90

        # ---- Tap 2 ----
        PROBE
        CHAMBER_THERMAL_CAPTURE TEMP={chamber_temp} TAP=2 IGNORE=0
        G91
        G1 Z{TAP_LIFT} F900
        G90

        # ---- Tap 3 ----
        PROBE
        CHAMBER_THERMAL_CAPTURE TEMP={chamber_temp} TAP=3 IGNORE=0
        G91
        G1 Z{TAP_LIFT} F900
        G90

        # ---- Tap 4 ----
        PROBE
        CHAMBER_THERMAL_CAPTURE TEMP={chamber_temp} TAP=4 IGNORE=0
        G91
        G1 Z{TAP_LIFT} F900
        G90
    {% endfor %}

    # Stability check at final temperature
    # Wait 15 minutes and measure every 3 minutes to check for stability
    RESPOND PREFIX="TEST" MSG="Starting stability check at {END}C - measuring every 3 minutes for 15 minutes"
    M117 Stability check: {END}C for 15min
    
    # Ensure we're still at the target temperature
    {% set final_target_temp = END %}
    TEMPERATURE_WAIT SENSOR="temperature_fan exhaust_fan" MINIMUM={final_target_temp - 1} MAXIMUM={final_target_temp + 2}
    
    # Take measurements at 0, 3, 6, 9, 12, and 15 minutes (6 measurements total)
    # Each measurement is 3 minutes apart
    {% set measurement_count = 6 %}
    {% set interval_minutes = 3 %}
    {% set total_minutes = 15 %}
    
    {% for i in range(measurement_count) %}
        {% set elapsed_minutes = i * interval_minutes %}
        
        {% if i == 0 %}
            RESPOND PREFIX="TEST" MSG="Stability check: initial measurement at {elapsed_minutes} minutes"
            M117 Stability: {elapsed_minutes}min (initial)
        {% else %}
            RESPOND PREFIX="TEST" MSG="Stability check: waiting {interval_minutes} minutes until next measurement..."
            M117 Stability: waiting {interval_minutes}min
            G4 P{interval_minutes * 60 * 1000}  # Wait 3 minutes (convert to milliseconds)
            RESPOND PREFIX="TEST" MSG="Stability check: measurement at {elapsed_minutes} minutes"
            M117 Stability: {elapsed_minutes}min
        {% endif %}
        
        # Get current chamber temperature
        {% set stability_temp = printer["temperature_fan exhaust_fan"].temperature|float %}
        {% set stability_temp_str = "%.1f"|format(stability_temp) %}
        RESPOND PREFIX="TEST" MSG="Stability measurement #{i + 1} at {elapsed_minutes}min: temp={stability_temp_str}C"
        
        # Take 4 taps (same as main test)
        # ---- Stability Tap 1 (ignored) ----
        PROBE
        CHAMBER_THERMAL_CAPTURE TEMP={stability_temp} TAP=1 IGNORE=1
        G91
        G1 Z{TAP_LIFT} F900
        G90

        # ---- Stability Tap 2 ----
        PROBE
        CHAMBER_THERMAL_CAPTURE TEMP={stability_temp} TAP=2 IGNORE=0
        G91
        G1 Z{TAP_LIFT} F900
        G90

        # ---- Stability Tap 3 ----
        PROBE
        CHAMBER_THERMAL_CAPTURE TEMP={stability_temp} TAP=3 IGNORE=0
        G91
        G1 Z{TAP_LIFT} F900
        G90

        # ---- Stability Tap 4 ----
        PROBE
        CHAMBER_THERMAL_CAPTURE TEMP={stability_temp} TAP=4 IGNORE=0
        G91
        G1 Z{TAP_LIFT} F900
        G90
    {% endfor %}
    
    RESPOND PREFIX="TEST" MSG="Stability check complete after 15 minutes"

    # Shut off exhaust fan, bed heater, nevermore, and part cooling fan
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET=0
    SET_HEATER_TEMPERATURE HEATER=heater_bed TARGET=0
    SET_FAN_SPEED FAN=nevermore SPEED=0
    M106 S0  # Turn off part cooling fan

    # Final lift away from the bed
    G91
    G1 Z{FINAL_LIFT} F600
    G90

    RESPOND PREFIX="TEST" MSG="Generating plots..."
    RUN_SHELL_COMMAND CMD=CHAMBER_THERMAL_LOG PARAMS="plot"

    M117 Chamber thermal test complete
    RESPOND PREFIX="TEST" MSG="Chamber thermal test complete. Check ~/printer_data/config/plots"

