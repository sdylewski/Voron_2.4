[gcode_shell_command NOZZLE_THERMAL_LOG]
command: python3 ~/printer_data/config/plots/nozzle_thermal_log.py
timeout: 120.0
verbose: True


[gcode_macro TEST_NOZZLE_THERMAL]
description: "Measure nozzle thermal expansion vs temp using OptoTap"
# Optional params: START, END, STEP (all in Â°C)
gcode:
    {% set START = params.START|default(30)|int %}
    {% set END   = params.END|default(300)|int %}
    {% set STEP  = params.STEP|default(10)|int %}

    # Safety / preconditions
    M117 "Nozzle thermal test: starting"
    RESPOND PREFIX="TEST" MSG="Starting nozzle thermal test from {START}C to {END}C step {STEP}C"

    # Make sure we're homed and Z is safe
    G28
    G90
    G1 Z10 F600

    # Ensure bed mesh etc. won't mess with the readings
    # (Uncomment or adapt depending on your setup)
    # BED_MESH_CLEAR

    # Move to your probing position for OptoTap.
    # >>> IMPORTANT: adjust this for your printer <<<
    # You probably already have a macro that moves to OptoTap position,
    # e.g. OPTOTAP_PROBE_POS or something similar.
    # Replace the next line with whatever you normally use:
    # CALL_OPTOTAP_PROBE_POSITION
    # For now, just move to the center:
    G1 X150 Y150 F6000

    # Make sure nozzle is cool-ish before starting
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={START + 5}

    # Initialize CSV
    RUN_SHELL_COMMAND CMD=NOZZLE_THERMAL_LOG PARAMS="init"

    # Main loop
    {% for T in range(START, END + 1, STEP) %}
        RESPOND PREFIX="TEST" MSG="Heating to {{T}}C"
        M117 "Thermal test: {{T}}C"

        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={{T}}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={{T - 2}} MAXIMUM={{T + 2}}

        # Small settle time to let mechanics relax (optional)
        G4 P2000

        # Lift a bit before probing
        G1 Z10 F600

        # Run your actual probe routine.
        # If you use an OptoTap macro like PROBE_Z or PROBE,
        # put it here. For a standard PROBE:
        PROBE

        # Last probe result in Klipper is printer.probe.last_z_result
        {% set z = printer.probe.last_z_result|float %}

        RESPOND PREFIX="TEST" MSG="T={{T}}C, Z={{'%.5f' % z}}"
        RUN_SHELL_COMMAND CMD=NOZZLE_THERMAL_LOG PARAMS="add {{T}} {{'%.5f' % z}}"
    {% endfor %}

    # Turn off nozzle
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0

    RESPOND PREFIX="TEST" MSG="Generating plot..."
    RUN_SHELL_COMMAND CMD=NOZZLE_THERMAL_LOG PARAMS="plot"

    M117 "Thermal test complete"
    RESPOND PREFIX="TEST" MSG="Nozzle thermal test complete. Data+plot in config/plots"

