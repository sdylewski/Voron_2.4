[gcode_shell_command NOZZLE_THERMAL_LOG]
command: python3 /home/scott/nozzle_thermal_log.py
timeout: 120.0
verbose: True


[gcode_macro TEST_NOZZLE_THERMAL]
description: "Measure nozzle thermal expansion vs temp using OptoTap"
gcode:
    {% set START = params.START|default(30)|int %}
    {% set END   = params.END|default(300)|int %}
    {% set STEP  = params.STEP|default(10)|int %}

    # Determine current tool as T0/T1/T2 based on active extruder name
    {% set ext_name = printer.toolhead.extruder %}
    {% if ext_name == "extruder" %}
        {% set TOOL = "T0" %}
    {% else %}
        # ext_name is like "extruder1", "extruder2", etc.
        {% set TOOL = "T" ~ ext_name[8:] %}
    {% endif %}

    # Compute bed center from axis_max/2
    {% set xmax = printer.toolhead.axis_maximum.x|float %}
    {% set ymax = printer.toolhead.axis_maximum.y|float %}
    {% set cx = xmax / 2.0 %}
    {% set cy = ymax / 2.0 %}

    M117 Nozzle thermal test: starting
    RESPOND PREFIX="TEST" MSG="Starting nozzle thermal test for {TOOL} from {START}C to {END}C step {STEP}C"

    # Home and get safe Z
    G28
    G90
    G1 Z10 F600

    # Limit nozzle to 50% power so heat ramp is slow and stable
    RESPOND PREFIX="TEST" MSG="Limiting extruder power to 50%"
    SET_HEATER_TUNING HEATER=extruder TARGET_POWER=0.5

    # Move to bed center
    G1 X{cx} Y{cy} F6000

    # Retract filament a bit to reduce dribble during the test
    RESPOND PREFIX="TEST" MSG="Retracting filament 5mm to reduce ooze"
    G91
    G1 E-5 F1800
    G90

    # Make sure nozzle is cool-ish before starting
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={START + 5}

    # Initialize CSV for this tool/run
    RUN_SHELL_COMMAND CMD=NOZZLE_THERMAL_LOG PARAMS="init {TOOL}"

    # Main measurement loop
    {% for T in range(START, END + 1, STEP) %}
        RESPOND PREFIX="TEST" MSG="Heating {TOOL} to {T}C"
        M117 Thermal test {TOOL}: {T}C

        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={T}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={T - 2} MAXIMUM={T + 2}

        # 3s heat soak at this temperature
        G4 P3000

        # ---- Tap 1 (ignored) ----
        G1 Z5 F600
        PROBE
        G91
        G1 Z2 F900
        G90
        {% set z1 = printer.probe.last_z_result|float %}
        RESPOND PREFIX="TEST" MSG="{TOOL}: T={T}C tap 1/4 (ignored) Z={'%.5f' % z1}"

        # ---- Tap 2 ----
        G1 Z5 F600
        PROBE
        G91
        G1 Z2 F900
        G90
        {% set z2 = printer.probe.last_z_result|float %}
        RESPOND PREFIX="TEST" MSG="{TOOL}: T={T}C tap 2/4 Z={'%.5f' % z2}"

        # ---- Tap 3 ----
        G1 Z5 F600
        PROBE
        G91
        G1 Z2 F900
        G90
        {% set z3 = printer.probe.last_z_result|float %}
        RESPOND PREFIX="TEST" MSG="{TOOL}: T={T}C tap 3/4 Z={'%.5f' % z3}"

        # ---- Tap 4 ----
        G1 Z5 F600
        PROBE
        G91
        G1 Z2 F900
        G90
        {% set z4 = printer.probe.last_z_result|float %}
        RESPOND PREFIX="TEST" MSG="{TOOL}: T={T}C tap 4/4 Z={'%.5f' % z4}"

        # Average last 3 taps (ignore z1)
        {% set sumv = z2 + z3 + z4 %}
        {% set avg  = sumv / 3.0 %}

        # Repeatability: range (max - min) over z2, z3, z4
        {% set minv = z2 %}
        {% if z3 < minv %}{% set minv = z3 %}{% endif %}
        {% if z4 < minv %}{% set minv = z4 %}{% endif %}

        {% set maxv = z2 %}
        {% if z3 > maxv %}{% set maxv = z3 %}{% endif %}
        {% if z4 > maxv %}{% set maxv = z4 %}{% endif %}

        {% set span = maxv - minv %}

        RESPOND PREFIX="TEST" MSG="{TOOL}: T={T}C avgZ={'%.5f' % avg} repeat_span={'%.5f' % span} mm (3 taps)"

        # Log averaged Z for this temperature
        RUN_SHELL_COMMAND CMD=NOZZLE_THERMAL_LOG PARAMS="add {T} {'%.5f' % avg}"
    {% endfor %}

    # Turn off nozzle
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0

    # Restore nozzle power to normal
    RESPOND PREFIX="TEST" MSG="Restoring extruder power to 100%"
    SET_HEATER_TUNING HEATER=extruder TARGET_POWER=1.0

    RESPOND PREFIX="TEST" MSG="Generating plot for {TOOL}..."
    RUN_SHELL_COMMAND CMD=NOZZLE_THERMAL_LOG PARAMS="plot"

    M117 Thermal test complete for {TOOL}
    RESPOND PREFIX="TEST" MSG="Nozzle thermal test complete for {TOOL}. Files in printer_data/config/plots"

