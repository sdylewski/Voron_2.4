[gcode_shell_command NOZZLE_THERMAL_LOG]
command: python3 /home/scott/nozzle_thermal_log.py
timeout: 120.0
verbose: True

[gcode_macro NOZZLE_THERMAL_CAPTURE]
description: "Capture last probe Z and log to nozzle_thermal_log.py"
gcode:
    {% set TOOL = params.TOOL %}
    {% set T    = params.TEMP|float %}
    {% set TAP  = params.TAP|int %}
    {% set IGN  = params.IGNORE|default(0)|int %}
    {% set z    = printer.probe.last_z_result|float %}

    {% set ZSTR = '%.5f'|format(z) %}

    {% if IGN %}
        RESPOND PREFIX="TEST" MSG="{TOOL}: T={T}C tap {TAP} (ignored) Z={ZSTR}"
    {% else %}
        RESPOND PREFIX="TEST" MSG="{TOOL}: T={T}C tap {TAP} Z={ZSTR}"
        {% set PARAM = "add_raw %s %0.1f %d %s" % (TOOL, T, TAP, ZSTR) %}
        RUN_SHELL_COMMAND CMD=NOZZLE_THERMAL_LOG PARAMS="{PARAM}"
    {% endif %}


[gcode_macro TEST_NOZZLE_THERMAL]
description: "Measure nozzle thermal expansion vs temp using OptoTap"
gcode:
    {% set START = params.START|default(30)|int %}
    {% set END   = params.END|default(300)|int %}
    {% set STEP  = params.STEP|default(10)|int %}

    # Per-test Z lift settings (all relative moves)
    {% set TAP_LIFT     = params.TAP_LIFT|default(2.0)|float %}
    {% set INITIAL_LIFT = params.INITIAL_LIFT|default(5.0)|float %}
    {% set FINAL_LIFT   = params.FINAL_LIFT|default(25.0)|float %}

    # Determine current tool as T0/T1/T2 based on active extruder name
    {% set ext_name = printer.toolhead.extruder %}
    {% if ext_name == "extruder" %}
        {% set TOOL = "T0" %}
    {% else %}
        {% set TOOL = "T" ~ ext_name[8:] %}
    {% endif %}

    # Compute bed center from axis_max/2
    {% set xmax = printer.toolhead.axis_maximum.x|float %}
    {% set ymax = printer.toolhead.axis_maximum.y|float %}
    {% set cx = xmax / 2.0 %}
    {% set cy = ymax / 2.0 %}

    M117 Nozzle thermal test: starting
    RESPOND PREFIX="TEST" MSG="Starting nozzle thermal test for {TOOL} from {START}C to {END}C step {STEP}C"

    # Home and then lift up a bit *relative* to wherever homing left Z
    G28
    G91
    G1 Z{INITIAL_LIFT} F600
    G90

    # Move to bed center
    G1 X{cx} Y{cy} F6000

    # Cool the nozzle before starting
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0
    TEMPERATURE_WAIT SENSOR=extruder MAXIMUM={START + 5}

    # Start new CSV file
    RUN_SHELL_COMMAND CMD=NOZZLE_THERMAL_LOG PARAMS="init {TOOL}"

    # Main measurement loop
    {% for T in range(START, END + 1, STEP) %}
        RESPOND PREFIX="TEST" MSG="Heating {TOOL} to {T}C"
        M117 Thermal test {TOOL}: {T}C

        SET_HEATER_TEMPERATURE HEATER=extruder TARGET={T}
        TEMPERATURE_WAIT SENSOR=extruder MINIMUM={T - 2} MAXIMUM={T + 2}

        G4 P3000

        # ---- Tap 1 (ignored) ----
        PROBE
        NOZZLE_THERMAL_CAPTURE TOOL={TOOL} TEMP={T} TAP=1 IGNORE=1
        G91
        G1 Z{TAP_LIFT} F900
        G90

        # ---- Tap 2 ----
        PROBE
        NOZZLE_THERMAL_CAPTURE TOOL={TOOL} TEMP={T} TAP=2 IGNORE=0
        G91
        G1 Z{TAP_LIFT} F900
        G90

        # ---- Tap 3 ----
        PROBE
        NOZZLE_THERMAL_CAPTURE TOOL={TOOL} TEMP={T} TAP=3 IGNORE=0
        G91
        G1 Z{TAP_LIFT} F900
        G90

        # ---- Tap 4 ----
        PROBE
        NOZZLE_THERMAL_CAPTURE TOOL={TOOL} TEMP={T} TAP=4 IGNORE=0
        G91
        G1 Z{TAP_LIFT} F900
        G90
    {% endfor %}


    # Shut off nozzle
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=0

    # Final lift away from the bed
    G91
    G1 Z{FINAL_LIFT} F600
    G90

    RESPOND PREFIX="TEST" MSG="Generating plots for {TOOL}..."
    RUN_SHELL_COMMAND CMD=NOZZLE_THERMAL_LOG PARAMS="plot"

    M117 Thermal test complete for {TOOL}
    RESPOND PREFIX="TEST" MSG="Nozzle thermal test complete for {TOOL}. Check ~/printer_data/config/plots"

