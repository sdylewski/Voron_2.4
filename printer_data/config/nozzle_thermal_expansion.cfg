[gcode_shell_command NOZZLE_THERMAL_LOG]
command: bash -lc 'python3 ~/printer_data/config/plots/nozzle_thermal_log.py'
timeout: 120.0
verbose: True


#!/usr/bin/env python3
import sys
import os
import csv
from datetime import datetime

# Base directory (works for any username)
BASE_DIR = os.path.expanduser("~/printer_data/config/plots")

# File that stores the "current run id"
RUN_INFO_FILE = os.path.join(BASE_DIR, "nozzle_thermal_current_run.txt")


def ensure_base_dir():
    os.makedirs(BASE_DIR, exist_ok=True)


def make_run_id(tool_name: str) -> str:
    """Build a run ID like 'T0_20251117_042314'."""
    ts = datetime.now().strftime("%Y%m%d_%H%M%S")
    return f"{tool_name}_{ts}"


def write_current_run(run_id: str):
    with open(RUN_INFO_FILE, "w") as f:
        f.write(run_id.strip() + "\n")


def read_current_run():
    if not os.path.exists(RUN_INFO_FILE):
        return None
    with open(RUN_INFO_FILE, "r") as f:
        return f.read().strip() or None


def get_paths_for_run(run_id: str):
    data_file = os.path.join(BASE_DIR, f"nozzle_thermal_{run_id}.csv")
    plot_file = os.path.join(BASE_DIR, f"nozzle_thermal_{run_id}.png")
    return data_file, plot_file


def cmd_init(tool_name: str):
    """Initialize a new run for given tool (T0, T1, etc)."""
    ensure_base_dir()
    tool_name = tool_name.strip().upper()
    if not tool_name.startswith("T"):
        tool_name = "T" + tool_name

    run_id = make_run_id(tool_name)
    data_file, _ = get_paths_for_run(run_id)

    # Record the current run ID
    write_current_run(run_id)

    # Create CSV and write header
    with open(data_file, "w", newline="") as f:
        writer = csv.writer(f)
        writer.writerow(["timestamp", "tool", "temperature_C", "z_height"])

    print(f"[nozzle_thermal] Init run_id={run_id}")
    print(f"[nozzle_thermal] Data file: {data_file}")


def cmd_add(temp_str: str, z_str: str):
    """Append one data point (T, Z) to the current run."""
    ensure_base_dir()
    run_id = read_current_run()
    if run_id is None:
        print("[nozzle_thermal] ERROR: No current run. Call 'init <tool>' first.")
        return

    data_file, _ = get_paths_for_run(run_id)

    try:
        temp = float(temp_str)
        z = float(z_str)
    except ValueError:
        print(f"[nozzle_thermal] Invalid numeric values: temp={temp_str}, z={z_str}")
        return

    ts = datetime.now().isoformat(timespec="seconds")
    tool_name = run_id.split("_", 1)[0]

    with open(data_file, "a", newline="") as f:
        writer = csv.writer(f)
        writer.writerow([ts, tool_name, temp, z])

    print(f"[nozzle_thermal] Logged: run_id={run_id}, T={temp}C, Z={z}")


def linear_regression(xs, ys):
    """Simple least-squares linear fit: y = a*x + b."""
    n = len(xs)
    if n < 2:
        return None, None

    Sx = sum(xs)
    Sy = sum(ys)
    Sxx = sum(x * x for x in xs)
    Sxy = sum(x * y for x, y in zip(xs, ys))

    denom = n * Sxx - Sx * Sx
    if denom == 0:
        return None, None

    a = (n * Sxy - Sx * Sy) / denom
    b = (Sy - a * Sx) / n
    return a, b


def cmd_plot():
    """Generate plot and perform linear regression for the current run."""
    import matplotlib
    matplotlib.use("Agg")  # headless
    import matplotlib.pyplot as plt

    ensure_base_dir()
    run_id = read_current_run()
    if run_id is None:
        print("[nozzle_thermal] ERROR: No current run. Call 'init <tool>' first.")
        return

    data_file, plot_file = get_paths_for_run(run_id)

    if not os.path.exists(data_file):
        print(f"[nozzle_thermal] No data file found for run_id={run_id}: {data_file}")
        return

    temps = []
    zs = []

    with open(data_file, "r") as f:
        reader = csv.DictReader(f)
        for row in reader:
            try:
                temps.append(float(row["temperature_C"]))
                zs.append(float(row["z_height"]))
            except (ValueError, KeyError):
                continue

    if not temps:
        print("[nozzle_thermal] No valid data rows to plot.")
        return

    # Linear regression (degree-1 polynomial)
    a, b = linear_regression(temps, zs)
    if a is not None and b is not None:
        # Slope is mm/°C -> convert to µm/°C
        slope_mm_per_C = a
        slope_um_per_C = a * 1000.0
        print("[nozzle_thermal] Linear fit (Z = a*T + b):")
        print(f"    a = {slope_mm_per_C:.6f} mm/°C  ({slope_um_per_C:.3f} µm/°C)")
        print(f"    b = {b:.6f} mm")

    # Plot data
    plt.figure()

