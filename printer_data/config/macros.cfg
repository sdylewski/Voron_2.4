
#####################################################################
#   Macros
#####################################################################


#####################################################################
#   A better print_start macro for v2/trident
#####################################################################
## *** THINGS TO UNCOMMENT: ***
## Bed mesh (2 lines at 2 locations)
## Nevermore (if you have one)
## Z_TILT_ADJUST (For Trident only)
## QUAD_GANTRY_LEVEL (For V2.4 only)

# print_start based on: https://github.com/jontek2/A-better-print_start-macro/blob/main/README.md
[gcode_macro PRINT_START]
gcode:
  # This part fetches data from your slicer. Such as bed, extruder, and chamber temps and size of your printer.
  #{% set BED_TEMP = params.BED_TEMP|int %}
  #{% set TOOL_TEMP = params.EXTRUDER_TEMP|int %}
  {% set target_chamber = params.CHAMBER_TEMP|default("25")|int %}
  {% set filament        = params.FILAMENT|default("") %}
  {% set x_wait = printer.toolhead.axis_maximum.x|float / 2 %}
  {% set y_wait = printer.toolhead.axis_maximum.y|float / 2 %}
  {% set QGL_OK = printer.quad_gantry_level.applied %}
    {% set TOOL = params.TOOL | default(-1)| int %}
    {% set TOOL_TEMP = params.TOOL_TEMP | default(0) | int %}
    {% set BED_TEMP = params.BED_TEMP | default(0) | int %}

    STOP_CRASH_DETECTION
    T0 # set tool to zero

    set_nozzle_leds_on  
    SET_PIN PIN=caselight VALUE=1       ; turn case light on
  # Home the printer, set absolute positioning and update the Stealthburner LEDs.
  # STATUS_HOMING                                         # Set LEDs to homing-mode
  M117 Homing all
  G28 X Y Z                                               # initially Full home (XYZ).  now only x,y.  do z later.
  G90                                                   # Absolute position

  ##  Uncomment for bed mesh (1 of 2 for bed mesh)
  #BED_MESH_CLEAR                                       # Clear old saved bed mesh (if any)
  SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET=0 # turn off exhaust
  # Check if the bed temp is higher than 90c - if so then trigger a heatsoak.
  {% if params.BED_TEMP|int > 90 %}
    #SET_DISPLAY_TEXT MSG="Bed: {BED_TEMP}c"           # Display info on display
    RESPOND MSG="Bed: {BED_TEMP}c"
    #STATUS_HEATING                                      # Set LEDs to heating-mode
    M190 S{BED_TEMP}                                  # Set the target temp for the bed

    M106 S255                                           # Turn on the part cooling PT-fan
    ##  Uncomment if you have a Nevermore. 
    #SET_PIN PIN=nevermore VALUE=1                      # Turn on the nevermore
    M106 P2 S255                # nevermore on 100%
    G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed so fan blows down on center

    RESPOND MSG="Heatsoak: {target_chamber}c"  # Display info on display
    # wait for chamber to warm up.  reduce it slightly so it starts faster.
    TEMPERATURE_WAIT SENSOR="temperature_fan exhaust_fan" MINIMUM={target_chamber - 1}
    #TEMPERATURE_WAIT SENSOR="temperature_sensor chamber" MINIMUM={target_chamber}   # Waits for chamber temp
    RESPOND MSG="Heatsoak: {target_chamber}c Achieved"  # Display info on display
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET={target_chamber}
    M106 S0                                           # Turn off the part cooling PT-fan
    M106 S0                                            # Turn off the part cooling PT-fan
  # If the bed temp is not over 90c, then skip the heatsoak and just heat up to set temp with a 5 min soak
  {% else %}
    RESPOND MSG="Bed: {BED_TEMP}c"           # Display info on display
    #STATUS_HEATING                                      # Set LEDs to heating-mode
    #G1 X{x_wait} Y{y_wait} Z15 F9000                    # Go to center of the bed
    M190 S{BED_TEMP}                                  # Set the target temp for the bed
    RESPOND MSG="Chamber temp set at: {target_chamber}c"  # Display info on display
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET={target_chamber}
    #RESPOND MSG="Soak for 5 min"               # Display info on display
    #G4 P300000                                          # Wait 5 min for the bedtemp to stabilize
    #G4 P100000                                          # wait 2 minutes for bedtemp stabilization
  {% endif %}

  # # Exhaust management by filament ---
  # {% if BED_TEMP > 90 %}
  #   RESPOND MSG="Chamber at {printer['temperature_fan exhaust_fan'].temperature|round(1)}C -> enabling AUTO"
  #   EXHAUST_AUTO T={target_chamber}
  # {% else %}
  #   RESPOND MSG="PLA/PETG mode: Exhaust FULL"
  #   EXHAUST_FULL
  # {% endif %}

  # Heat hotend to 150c. This helps with getting a correct Z-home.
  RESPOND MSG="Hotend: 150c"                   # Display info on display
  #M109 S150   
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={150}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={150-1.5} MAXIMUM={150+1.5}                                          # Heat hotend to 150c

  #  Uncomment for V2.4 (Quad gantry level AKA QGL)
  RESPOND MSG="Bed Leveling"                      # Display info on display
  # STATUS_LEVELING                                      # Set LEDs to leveling-mode
  #_QUAD_GANTRY_LEVEL_AND_MESH                                   # Level the printer via QGL
  QUAD_GANTRY_LEVEL

  #RESPOND MSG="Scrubbing..."
  #CLEAN_NOZZLE
  # not needed since we do another home for bed_mesh_calibrate:
  G28 Z                                                 # Home Z again after QGL

  #  Uncomment for bed mesh (2 of 2 for bed mesh)
  RESPOND MSG="Bed mesh"                      # Display info on display
  #STATUS_MESHING                                       # Set LEDs to bed mesh-mode
  #BED_MESH_CLEAR
  BED_MESH_CALIBRATE ADAPTIVE=1                                 # Start the bed mesh (add ADAPTIVE=1) for adaptive bed mesh
  # BED_MESH_CALIBRATE METHOD=rapid_scan ADAPTIVE=1 # for eddy probe

  # Heat up the hotend up to target via data from slicer
  CLEAN_NOZZLE_PARK # park nozzle in bucket while heating
  RESPOND MSG="Hotend: {TOOL_TEMP}c"     # Display info on display
  # STATUS_HEATING                                        # Set LEDs to heating-mode
  #G1 X{x_wait} Y{y_wait} Z15 F9000                      # Go to center of the bed
  M107                                                  # Turn off partcooling fan
  #M109 S{TOOL_TEMP}                               # Heat the hotend to set temp
  SET_HEATER_TEMPERATURE HEATER=extruder TARGET={TOOL_TEMP}
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM={TOOL_TEMP-1.5} MAXIMUM={TOOL_TEMP+1.5}

  #RESPOND MSG="Scrubbing..."
  #CLEAN_NOZZLE

  # Get ready to print by doing a primeline and updating the LEDs
  STATUS_PRINTING                                       # Set LEDs to printing-mode
  #G0 X{x_wait - 50} Y4 F10000                           # Go to starting point
#   G0 Z0.4                                               # Raise Z to 0.4
#   G91                                                   # Incremental positioning 
#   G1 X100 E20 F1000                                     # Primeline
  G90     
  # disable filament sensor when priming:
  SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=0                                              # Absolute position
  RESPOND MSG="KAMP Line Purge"
  LINE_PURGE # purge nozzle
  RESPOND MSG="Printing..."
  STATUS_PRINTING
  SET_FILAMENT_SENSOR SENSOR=encoder_sensor ENABLE=1   

    {% if TOOL >= 0 %}
        M104 T0 S0 ; shutdown T0.  If it's up first it will be heated below.
        T{params.TOOL}
        {% set initialToolTemp = 'T' ~ params.TOOL|string ~ '_TEMP' %}
        M117 Waiting on T{params.TOOL} S{params[initialToolTemp]}C
        M109 S{params[initialToolTemp]}
    {% else %}
        M109 S{TOOL_TEMP}
    {% endif %}

    START_CRASH_DETECTION
    

[gcode_macro G32] # Quad Gantry Level
gcode:
    SAVE_GCODE_STATE NAME=STATE_G32
    G90
    G28
    QUAD_GANTRY_LEVEL
    G28    
    ##  Uncomment for 300 build
    #G0 X150 Y150 Z30 F3600
    RESTORE_GCODE_STATE NAME=STATE_G32


#   Use PRINT_START for the slicer starting script - please customise for your slicer of choice
# [gcode_macro PRINT_START]
# gcode:
#     M117 Preparing to print
#     # Get first-layer bed-temp from slicer
#     {% set BED_TEMP = params.BED_TEMP|default(60)|float %}
#     # Get first-layer extruder-temp from slicer
#     {% set EXTRUDER_TEMP = params.EXTRUDER_TEMP|default(200)|float %}
#     # Get chember temnp from slicer
#     #{% set CHAMBER_TEMP = params.CHAMBER_TEMP|default(0)|float %}
#     M117 Warming up for bed leveling
#     M104 S150 # set extruder temp to 150 initially to get it ready
#     M140 S{BED_TEMP} # set bed temp
#     # RESPOND MSG="Homing axes with G32"
#     M117 Homing all axes
    
#     M190 S{BED_TEMP} ; wait for bed temp
#     M117 Doing bed zero G32
#     G32                            ; home all axes & do leveling
#     G90                            ; absolute positioning
#     M117 Doing bed mesh
#     BED_MESH_CLEAR
#     BED_MESH_CALIBRATE
#     M117 Heating to print temp
#     M104 S{EXTRUDER_TEMP} # set extruder temp
#     G1 Z20 F3000                   ; move nozzle away from bed
#     M109 S{EXTRUDER_TEMP} # wait for extruder temp
#     M117 KAMP Line Purge
#     LINE_PURGE # purge nozzle
#     M117 Printing...

#   Use PRINT_END for the slicer ending script - please customise for your slicer of choice
[gcode_macro PRINT_END]
gcode:
    # safe anti-stringing move coords
    {% set th = printer.toolhead %}
    {% set x_safe = th.position.x + 20 * (1 if th.axis_maximum.x - th.position.x > 20 else -1) %}
    {% set y_safe = th.position.y + 20 * (1 if th.axis_maximum.y - th.position.y > 20 else -1) %}
    {% set z_safe = [th.position.z + 20, th.axis_maximum.z]|min %}
    
    SAVE_GCODE_STATE NAME=STATE_PRINT_END
    
    M400                           ; wait for buffer to clear
    G92 E0                         ; zero the extruder
    G1 E-1.0 F1800                 ; retract filament 1mm to reduce dribble
    
    TURN_OFF_HEATERS
    
    G90                                      ; absolute positioning
    G0 X{x_safe} Y{y_safe} Z{z_safe} F20000  ; move nozzle to remove stringing
    G0 X{th.axis_maximum.x//4} Y{th.axis_maximum.y - 2} F3600  ; park nozzle at rear
    M107                                     ; turn off fan
    
    # BED_MESH_CLEAR
    RESTORE_GCODE_STATE NAME=STATE_PRINT_END
    SET_IDLE_TIMEOUT TIMEOUT=1800            ; set timeout to 30 minutes at end of print

    #M141 S0 # turn off exhaust fan

    # turn off LEDs
    set_logo_leds_off 
    #set_nozzle_leds_off  
    #SET_PIN PIN=caselight VALUE=0       ; turn case light off

    # if chamber is warm, leave fans on to cool down

[gcode_macro _CG28]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28
    {% endif %}

[gcode_macro _CQGL]
gcode:
    {% if printer.quad_gantry_level.applied == False %}
        {% if "xyz" not in printer.toolhead.homed_axes %}
            G28 ; home if not already homed
        {% endif %}
        QUAD_GANTRY_LEVEL
        G28 Z
    {% endif %}
    
# Park front center
[gcode_macro PARKFRONT]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
        G28                           ; home if not already homed
    {% endif %}
    SAVE_GCODE_STATE NAME=PARKFRONT
    G90                               ; absolute positioning
    G0 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} Z{printer.toolhead.axis_maximum.z/2} F6000        
    RESTORE_GCODE_STATE NAME=PARKFRONT

[gcode_macro CLEAN_NOZZLE_PARK]
gcode:
    {% if "xyz" not in printer.toolhead.homed_axes %}
      G28
    {% endif %}

    G90
    ## Ooze position. Set this position right above the bucket.
    G1 X280 Y310 Z1 F6000

[gcode_macro CLEAN_NOZZLE]
variable_start_x: 274 # starting position - offset a bit to the right from the brush
variable_start_y: 306 # starting Y position - offset a bit to the front of the brush
variable_start_z: 1   # starting Z height. This should barely touch the surface of the brush
variable_x_min: 234   # left side of the brush 
variable_x_max: 272   # right side of the brush
variable_y_min: 304   # front side of the brush - make sure the nozzle is over the last line of bristles 
variable_y_max: 311   # rear side of the brush - make sure the nozzle is over the first line of bristles
variable_z1: 0.5      # second z height of the nozzle over the brush - this should be with the nozzle slightly sunk in
variable_z2: 0      # third z height of the nozzle over the brush - this should be with the nozzle fully sunk into the brush, but not touching the bottom of it.
variable_wipe_qty: 1  # how many times to run the cleaning sequence
variable_wipe_spd: 200 #cleaning speed
variable_raise_distance: 10 # z height after cleaning is done
gcode:
	{% if "xyz" not in printer.toolhead.homed_axes %}
	  G28
	{% endif %}

	G90  ; absolute positioning
	### Move nozzle to start position
	G1 X{start_x} Y{start_y} F9000
	G1 X{x_max} Y{y_min} F9000
	G1 Z{start_z} F1500
	### Wipe nozzle
	{% for wipes in range(1, (wipe_qty + 1)) %} #wipe left and right
	  G1 Y{y_min} F{wipe_spd * 60}
	  G1 X{x_min} F{wipe_spd * 60}
	  G1 X{start_x} F{wipe_spd * 60}
	  
	  G1 Y{y_max} F{wipe_spd * 60}
	  G1 X{x_min} F{wipe_spd * 60}
	  G1 X{start_x} F{wipe_spd * 60}
	  G1 Z{z1} F1500
	  G1 Y{y_min} F{wipe_spd * 60}
	  G1 X{x_min} F{wipe_spd * 60}
	  G1 X{start_x} F{wipe_spd * 60}
	  
	  G1 Y{y_max} F{wipe_spd * 60}
	  G1 X{x_min} F{wipe_spd * 60}
	  G1 X{start_x} F{wipe_spd * 60}
	  G1 Z{z2} F1500
	  G1 Y{y_min} F{wipe_spd * 60}
	  G1 X{x_min} F{wipe_spd * 60}
	  G1 X{start_x} F{wipe_spd * 60}
	  
	  G1 Y{y_max} F{wipe_spd * 60}
	  G1 X{x_min} F{wipe_spd * 60}
	  G1 X{start_x} F{wipe_spd * 60}
	  
	  G1 Z{start_z} F1500
	{% endfor %}
	
	{% for wipes in range(1, (wipe_qty + 1)) %} #wipe diagonally
	  G1 Z{start_z} F1500
	  G1 X{x_min} Y{y_min} F{wipe_spd * 60}
	  G1 X{x_max} Y{y_max} F{wipe_spd * 60}
	  G1 X{x_min} Y{y_min} F{wipe_spd * 60}
	  G1 X{x_max} Y{y_max} F{wipe_spd * 60}
	  G1 Z{z1} F1500
	  G1 X{x_min} Y{y_min} F{wipe_spd * 60}
	  G1 X{x_max} Y{y_max} F{wipe_spd * 60}
	  G1 X{x_min} Y{y_min} F{wipe_spd * 60}
	  G1 X{x_max} Y{y_max} F{wipe_spd * 60}
	  G1 Z{z1} F1500
	  G1 X{x_min} Y{y_max} F{wipe_spd * 60}
	  G1 X{x_max} Y{y_min} F{wipe_spd * 60}
	  G1 X{x_min} Y{y_max} F{wipe_spd * 60}
	  G1 X{x_max} Y{y_min} F{wipe_spd * 60}
	  #G1 Z{z2} F1500
	  #G1 X{x_min} Y{y_min} F{wipe_spd * 60}
	  #G1 X{x_max} Y{y_max} F{wipe_spd * 60}
	  #G1 X{x_min} Y{y_min} F{wipe_spd * 60}
	  #G1 X{x_max} Y{y_max} F{wipe_spd * 60}
	  #G1 X{x_min} Y{y_max} F{wipe_spd * 60}
	  #G1 X{x_max} Y{y_min} F{wipe_spd * 60}
	  #G1 X{x_min} Y{y_max} F{wipe_spd * 60}
	  #G1 X{x_max} Y{y_min} F{wipe_spd * 60}
	  #G1 X{start_x} Y{y_min} F{wipe_spd * 60}
	  
	  G1 Z{start_z} F1500
	{% endfor %}
	
	G1 X{start_x} Y{start_y} F9000 #go back to starting position
	## Raise nozzle
	G1 Z{raise_distance} 
	
[gcode_macro OFF]
gcode:
    set_logo_leds_off 
    set_nozzle_leds_off  
    # SET_LED LED=stealthburner_led GREEN=0 RED=0 BLUE=0 WHITE=0
    M84                                  ; turn steppers off
    TURN_OFF_HEATERS                     ; turn bed / hotend off
    M107                                 ; turn print cooling fan off
    #SET_FAN_SPEED FAN=Exhaust SPEED=0   ; turn exhaust fan off
    #SET_FAN_SPEED FAN=BedFans SPEED=0   ; bed fan off
    SET_PIN PIN=caselight VALUE=0       ; turn case light off
    # turn off stealthburner lights
    # SET_LED LED=stealthburner_led GREEN=0 RED=0 BLUE=0 WHITE=0
    # display sleep?

######################################################################
# Override M117 command with rawparams
######################################################################
# The macro below will override the default M117 command to echo the message.
# It uses the rawparams pseudo-variable that contains the full unparsed
# parameters that was passed to the M117 command.
# As this can include comments, we are trimming the text when a `;` or `#` is
# found, and escaping any existing `"`
[gcode_macro M117]
rename_existing: M117.1
gcode:
  {% if rawparams %}
    {% set escaped_msg = rawparams.split(';', 1)[0].split('\x23', 1)[0]|replace('"', '\\"') %}
    SET_DISPLAY_TEXT MSG="{escaped_msg}"
    RESPOND TYPE=command MSG="{escaped_msg}"
  {% else %}
    SET_DISPLAY_TEXT
  {% endif %}
  
[gcode_macro ON]
gcode:
    set_nozzle_leds_on  
    SET_PIN PIN=caselight VALUE=1       ; turn case light on
    
[pause_resume]


[gcode_macro _TEMP_STORE]
variable_resume_temp: 0
gcode:

[gcode_macro PAUSE]
description: Pause, cool to 150C, and park
rename_existing: PAUSE_BASE
gcode:
  {% set cur_target = printer.extruder.target|int %}
  SET_GCODE_VARIABLE MACRO=_TEMP_STORE VARIABLE=resume_temp VALUE={cur_target}

  {% if cur_target > 150 %}
    M117 Setting nozzle to 150C during pause
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET=150
  {% endif %}

  PAUSE_BASE

[gcode_macro RESUME]
description: Restore temp and resume
rename_existing: RESUME_BASE
gcode:
  {% set t = printer["gcode_macro _TEMP_STORE"].resume_temp|int %}
  {% if t > 0 %}
    M117 Returning nozzle to {t} during pause
    SET_HEATER_TEMPERATURE HEATER=extruder TARGET={t}
    TEMPERATURE_WAIT SENSOR=extruder MINIMUM={t-5}
    SET_GCODE_VARIABLE MACRO=_TEMP_STORE VARIABLE=resume_temp VALUE=0
  {% endif %}

  RESUME_BASE

#=====================================================
# PAUSE. defined in fluidd.cfg
# [gcode_macro PAUSE]
# rename_existing: BASE_PAUSE
# gcode:
#     RESPOND MSG="Pause macro start"
#     # Parameters
#     {% set z = params.Z|default(10)|int %}                                                   ; z hop amount

#     {% if printer['pause_resume'].is_paused|int == 0 %}
#         SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE={z}                              ; set z hop variable for reference in resume macro
#         SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=etemp VALUE={printer['extruder'].target}    ; set hotend temp variable for reference in resume macro

#         SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=0                                  ; disable filament sensor
#         SET_FILAMENT_SENSOR SENSOR=filament_encoder ENABLE=0                                  ; disable filament sensor
#         SAVE_GCODE_STATE NAME=PAUSE                                                          ; save current print position for resume
#         BASE_PAUSE                                                                           ; pause print
#         {% if (printer.gcode_move.position.z + z) < printer.toolhead.axis_maximum.z %}       ; check that zhop doesn't exceed z max
#             RESPOND MSG="Raisng z {z}mm"
#             G91                                                                              ; relative positioning
#             G1 Z{z} F900                                                                     ; raise Z up by z hop amount
#         {% else %}
#             { action_respond_info("Pause zhop exceeds maximum Z height.") }                  ; if z max is exceeded, show message and set zhop value for resume to 0
#             SET_GCODE_VARIABLE MACRO=RESUME VARIABLE=zhop VALUE=0
#         {% endif %}
#         G90   
#         RESPOND MSG="Printer max x={printer.toolhead.axis_maximum.x}"
#         RESPOND MSG="Printer max y={printer.toolhead.axis_maximum.y}"
#         RESPOND MSG="Moving toolhead to X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5}"                                                                                ; absolute positioning
#         G1 X{printer.toolhead.axis_maximum.x/2} Y{printer.toolhead.axis_minimum.y+5} F6000   ; park toolhead at front center
#         SAVE_GCODE_STATE NAME=PAUSEPARK                                                      ; save parked position in case toolhead is moved during the pause (otherwise the return zhop can error)
#         M104 S0                                                                              ; turn off hotend
#         SET_IDLE_TIMEOUT TIMEOUT=43200                                                       ; set timeout to 12 hours
#     {% endif %}
#     RESPOND MSG="End of Pause macro"

# #=====================================================
# # RESUME  defined in fluidd.cfg
# [gcode_macro RESUME]
# rename_existing: BASE_RESUME
# variable_zhop: 0
# variable_etemp: 0
# gcode:
#     # Parameters
#     {% set e = params.E|default(2.5)|int %}                                          ; hotend prime amount (in mm)
#     RESPOND MSG="Starting Resume macro"
#     {% if printer['pause_resume'].is_paused|int == 1 %}
#         SET_FILAMENT_SENSOR SENSOR=filament_switch ENABLE=1                          ; enable filament sensor
#         SET_FILAMENT_SENSOR SENSOR=filament_encoder ENABLE=1                          ; enable filament sensor
#         #INITIAL_RGB                                                                    ; reset LCD color
#         SET_IDLE_TIMEOUT TIMEOUT={printer.configfile.settings.idle_timeout.timeout}  ; set timeout back to configured value
#         {% if etemp > 0 %}
#             M109 S{etemp|int}                                                        ; wait for hotend to heat back up
#         {% endif %}
#         RESTORE_GCODE_STATE NAME=PAUSEPARK MOVE=1 MOVE_SPEED=100                     ; go back to parked position in case toolhead was moved during pause (otherwise the return zhop can error)
#         G91                                                                          ; relative positioning
#         M83                                                                          ; relative extruder positioning
#         {% if printer[printer.toolhead.extruder].temperature >= printer.configfile.settings.extruder.min_extrude_temp %}
#             G1 Z{zhop * -1} E{e} F900                                                ; prime nozzle by E, lower Z back down
#         {% else %}
#             G1 Z{zhop * -1} F900                                                     ; lower Z back down without priming (just in case we are testing the macro with cold hotend)
#         {% endif %}
#         RESTORE_GCODE_STATE NAME=PAUSE MOVE=1 MOVE_SPEED=60                          ; restore position
#         BASE_RESUME                                                                  ; resume print
#     {% endif %}
#     RESPOND MSG="End of Resume macro"
# 

#=====================================================
# CANCEL
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    G91 # Set to incremental mode
    G0 Z10 F600 # raise extruder
    G90 # Set back to absolute mode
    TURN_OFF_HEATERS
    G0 X5 Y220 # clear print
    CLEAR_PAUSE
    #SDCARD_RESET_FILE
    TIMELAPSE_RENDER  # added by scott to render even when we cancel print
    BASE_CANCEL_PRINT

[gcode_macro UNLOAD_FILAMENT]
description: Hot unload for ASA (Rapido Ace)
gcode:
  {% set TEMP = params.TEMP|default(295)|float %}    # 295–300C
  SAVE_GCODE_STATE NAME=UNLOAD_STATE
  M104 S{TEMP}
  M109 S{TEMP}
  M83
  G1 E15 F180        ; purge 15 mm
  G1 E-4.0 F2400     ; short fast retract 4 mm
  G4 P400            ; brief settle
  M400
  # Now pull filament by hand
  RESTORE_GCODE_STATE NAME=UNLOAD_STATE

#======================================================
# FILAMENT CHANGE
[gcode_macro Filament_Change]
gcode:
    RESPOND MSG="Filament Change macro starting"
    G1 E-20.0 F1800                 ; retract filament 5mm to reduce dribble
    PAUSE
    
    # # Save the G-code state
    # SAVE_GCODE_STATE NAME=filament_change

    # # Move the extruder to the side
    # #G1 X5 Y225 F4000
    
    # # Unload the filament
    # # {% if printer.extruder.can_reverse %} 
    #     RESPOND MSG="Retracting filament 50mm"
    #     G91
    #     G1 E-50 F100 # check distance that extruder needs to retract to clear gears
    #     G92 E0
    #     G90
    # # {% else %}
    # #     M117 Extruder cannot reverse
    # # {% endif %}
    
    # # Wait for user interaction to confirm new roll of filament
    # M117 Pausing... Please insert new filament
    # PAUSE # ??  scott
    # # then wait for a "resume"?
    # RESPOND MSG="Priming after filament change"
    # # Prime the nozzle with new filament
    # G91                 # relative positioning
    # G1 E10 F100         # extrude 10mm
    # G92 E0
    # G1 E5 F200          # extrude another 5mm
    # G90                 # absolute positioning
    # RESPOND MSG="Done with priming"
    # # Restore the G-code state
    # RESTORE_GCODE_STATE NAME=filament_change
    RESPOND MSG="Done with Filament_Change macro"
    
[gcode_macro M600]
gcode:
    #LCDRGB R=0 G=1 B=0  ; Turn LCD green
    PAUSE                ; Pause

[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10
description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU
gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(50)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = printer.toolhead.axis_minimum.y + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}


[gcode_macro M141]
description: Override slicer-issued M141 for chamber
variable_chamber_target: 0
gcode:
    {% set s = params.S|default(0)|int %}
    SET_GCODE_VARIABLE MACRO=M141 VARIABLE=chamber_target VALUE={s}
    RESPOND MSG="M141 Chamber target set to {s}°C"

    # Now set the chamber (exhaust fan) target
    SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET={s}


[gcode_macro M191]
description: Wait for chamber temperature (OrcaSlicer issues this)
# RepRap-style: M191 S<temp> (wait until >= S)
# Optional: M191 R<temp>     (wait until <= R) — useful when cooling
gcode:
  {% if 'R' in params %}
    {% set r = params.R|float %}
    RESPOND MSG="m191 Waiting for chamber to cool to {r}°C"
    #TEMPERATURE_WAIT SENSOR="temperature_fan exhaust_fan" MAXIMUM={r}
  {% else %}
    {% set s = params.S|default(0)|float %}
    RESPOND MSG="m191 Waiting for chamber to reach {s}°C"
    # Make sure bed is already heating
    #TEMPERATURE_WAIT SENSOR="temperature_fan exhaust_fan" MINIMUM={s}
  {% endif %}



# # --- Exhaust fan control macros ---
# [gcode_macro EXHAUST_AUTO]
# description: Run exhaust in closed-loop at a target chamber temp
# # Usage: EXHAUST_AUTO T=45
# gcode:
#     {% set t = params.T|default(45)|int %}
#     SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET={t}
#     RESPOND MSG="Exhaust AUTO: target {t}°C"

# [gcode_macro EXHAUST_FULL]
# description: Force maximum exhaust flow (by setting a very low target)
# gcode:
#     SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET=0
#     RESPOND MSG="Exhaust FULL (target 0°C)"

# [gcode_macro EXHAUST_OFF]
# description: Force exhaust off (by setting an unreachable high target)
# gcode:
#     SET_TEMPERATURE_FAN_TARGET TEMPERATURE_FAN=exhaust_fan TARGET=200
#     RESPOND MSG="Exhaust OFF"
