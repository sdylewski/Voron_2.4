# THIS IS NOT AN EXHAUSTIVE LIST!
# use this file to override values in the other configs. 
# any value that is available in the configs can be overriden here
# just add the section ie: [tool_probe T0] and the value that is being overridden.  

# this file must be the last file to be included since values will be stored in the order they are
# received.  Klipper will take the last value and store that for the macros. 

[include dock_tuner.cfg]

#[include toolchanger_macros.cfg]
[include calibrate_offsets.cfg]

# nudge probe:
# [duplicate_pin_override]
# pins: PG10

# [filament_switch_sensor head1_attached]
# switch_pin: PG10
# pause_on_runout: false

[rounded_path]
resolution: 0.2 # the length of a circle approximation segments.
replace_g0: False # Use at your own risk

[force_move]
enable_force_move: True

[toolchanger]
# y and z are relative movements.  F is speed
# params_dropoff_path: [{'y':9.5 ,'z':4}, 
#                       {'y':9.5, 'z':2}, 
#                       {'y':5.5, 'z':0}, 
#                       {'y':0,   'z':0,  'f':0.5}, 
#                       {'y':0,   'z':-10}, 
#                       {'y':16,  'z':-10}]
# params_pickup_path: [{'z':-10, 'y':16}, 
#                     {'y':0,     'z':-10 }, 
#                     {'y':0,     'z':0,    'f':0.5, 'verify':1}, 
#                     {'y':5.5,   'z':0}, 
#                     {'y':9.5,   'z':2}, 
#                     {'y':9.5,   'z':4}]
params_dropoff_path: [{'z': 3.5,  'y': 4, 'f': 3.0},
                      {'z': 2,    'y': 1, 'f': 2.0},
                      {'z': 1,    'y': 0, 'f': 1.0},
                      {'z': 0,    'y': 0, 'f': 0.8},
                      {'z': -12,  'y': 0, 'f': 3}]

params_pickup_path:  [{'z': -12,  'y': 2, 'f': 3.0},
                      {'z': -10,  'y': 0, 'f': 2.0},
                      {'z': -5,   'y': 0, 'f': 1.0},
                      {'z': 1,    'y': 0, 'f': 0.75, 'verify': 1},
                      {'z': 2,    'y': 2, 'f': 1.25},
                      {'z': 3,    'y': 5, 'f': 2}]

params_safe_y: 120 # Y-position where all tools just don't touch dock
params_close_y: 45 # was 37
params_fast_speed: 10000 # Go as fast as we can
params_path_speed: 500 # 900 originally .  20mm/s for the actual change
require_tool_present: True # can set to False if using Beacon/Cartographer/Eddy for Z probe.

# add other overrides for toolchanger.cfg here:
# before_change_gcode:
#     {% set tn = "T"+(tool.tool_number|string) %}
#     {% if printer["gcode_macro " + tn ] %}
#        SET_GCODE_VARIABLE MACRO={tn} VARIABLE=color VALUE="''"
#     {% endif %}
#     m117 Before change gcode block.  setting tool temp and runout sensor off
#      # Turn off all the leds and filament runout sensors
#      # from discord Drakarah
#     {% for tool_nr in printer.toolchanger.tool_numbers %}
#         {% set tooltemp_param = 'T' ~ tool_nr|string ~ '_TEMP' %}
#         {% set tool_filament_runout_sensor = 'T' ~ tool_nr|string ~ '_filament_runout' %}
#         STATUS_OFF T={tool_nr}
#         SET_FILAMENT_SENSOR SENSOR={tool_filament_runout_sensor} ENABLE=0
#      {% endfor %}

# before_change_gcode (instrumented)
before_change_gcode:
  BEFORE_CHANGE_GCODE

after_change_gcode:
    m117 After change gcode block. 
    {% set tn = "T"+(tool.tool_number|string) %}
    {% if printer["gcode_macro " + tn ] %}
       SET_GCODE_VARIABLE MACRO={tn} VARIABLE=color VALUE="'c44'"
    {% endif %}
    {% if tool.params_input_shaper_freq_x %}
      SET_INPUT_SHAPER SHAPER_FREQ_X={tool.params_input_shaper_freq_x} SHAPER_FREQ_Y={tool.params_input_shaper_freq_y}
    {% endif %}

    m117 After change gcode block. Enabling only tool runout sensor. 
    # Turn off all the leds and filament runout sensors of the tools that are not used
     # from discord Drakarah
    {% for tool_nr in printer.toolchanger.tool_numbers %}
     {% set tooltemp_param = 'T' ~ tool_nr|string ~ '_TEMP' %}
      {% set tool_filament_runout_sensor = 'T' ~ tool_nr|string ~ '_filament_runout' %}
      {% if tooltemp_param in params %}
        STATUS_PRINTING T={tool_nr}
        SET_FILAMENT_SENSOR SENSOR={tool_filament_runout_sensor} ENABLE=1
      {% else %}
        STATUS_READY T={tool_nr}
        SET_FILAMENT_SENSOR SENSOR={tool_filament_runout_sensor} ENABLE=0
      {% endif %}
     {% endfor %}

[gcode_macro BEFORE_CHANGE_GCODE]
description: SC hook - runs before a tool change
gcode:
  {% set active = printer.toolchanger.active_tool|default(-1)|int %}
  {% set tn = "T" ~ (active|string) %}

  RESPOND PREFIX="TC" MSG='before_change_gcode: active={active} tn={tn}'

  {% if printer['gcode_macro ' ~ tn] is defined %}
    RESPOND PREFIX="TC" MSG='Setting variable "color" on {tn}'
    SET_GCODE_VARIABLE MACRO={tn} VARIABLE=color VALUE=""
  {% else %}
    RESPOND PREFIX="TC" MSG='{tn} macro not defined; skipping SET_GCODE_VARIABLE'
  {% endif %}

  M117 Before change gcode block. setting tool temp and runout sensor off
  {% for tool_nr in printer.toolchanger.tool_numbers %}
    {% set tool_filament_runout_sensor = 'T' ~ (tool_nr|string) ~ '_filament_runout' %}
    RESPOND PREFIX="TC" MSG='Loop tool_nr={tool_nr} -> runout sensor={tool_filament_runout_sensor}'
    STATUS_READY T={tool_nr}
    SET_FILAMENT_SENSOR SENSOR={tool_filament_runout_sensor} ENABLE=0
  {% endfor %}
  

# this section must be completed
[gcode_macro homing_override_config]
variable_sensorless_x: True
variable_sensorless_y: False
variable_homing_rebound_y: 5 # for sensorless you probably want this set to 20.
variable_stepper_driver: "tmc2209"
variable_homing_current: 1.0

# M109 macro is overridden to allow some deadband on the temp
# default is +- 1 degree.  So if the set temp is 250 the the default
# deadband will be 249-251.  You can adjust this here:

[gcode_macro SET_TEMPERATURE_WITH_DEADBAND]
variable_default_deadband: 4.0

# these values need to be set to match the location of your Calibration Switch
# [gcode_macro _CALIBRATION_SWITCH]
# variable_x: 201.5
# variable_y: 353.703125
# variable_z: 5.00
# gcode:

# [tools_calibrate]
# pin:   #pin that your calibration probe is connected to.
# travel_speed: 20  # mms to travel sideways for XY probing
# spread: 7  # mms to travel down from top for XY probing
# lower_z: 1.0  # The speed (in mm/sec) to move tools down onto the probe
# speed: 2  # The speed (in mm/sec) to retract between probes
# lift_speed: 4  # Z Lift after probing done, should be greater than any Z variance between tools
# final_lift_z: 6 
# sample_retract_dist:2
# samples_tolerance:0.05
# samples:5
# samples_result: median # median, average
# # Settings for nozzle probe calibration - optional.
# probe: probe # name of the nozzle probe to use
# trigger_to_bottom_z: 0.25 # Offset from probe trigger to vertical motion bottoms out. 
# # decrease if the nozzle is too high, increase if too low.

# [gcode_macro JOB_SUMMARY]
# description: Print job summary of tools used, temps, and chosen bed temp
# # Fallback if slicer doesn't pass a bed temp
# variable_default_bed: 60
# gcode:
#   {% set rng = range(0, 6) %}  {# supports up to T5 #}
#   {% set used = [] %}
#   {% set per_tool = [] %}
#   {% set bed_list = [] %}

#   {# Gather used tools and their params #}
#   {% for i in rng %}
#     {% set used_flag = (params['T' ~ i ~ '_USED']|default(0))|int %}
#     {% if used_flag == 1 %}
#       {% set _ = used.append(i) %}
#       {% set mat   = (params['T' ~ i ~ '_MAT']|default('N/A'))|string %}
#       {% set ttemp = (params['T' ~ i ~ '_TEMP']|default('N/A'))|string %}
#       {% set idle  = (params['T' ~ i ~ '_IDLE']|default('N/A'))|string %}
#       {% set btemp = (params['T' ~ i ~ '_BED']|default(None)) %}
#       {% if btemp is not none %}
#         {% set _ = bed_list.append(btemp|float) %}
#       {% endif %}
#       {% set _ = per_tool.append({'i':i, 'mat':mat, 'ttemp':ttemp, 'idle':idle, 'btemp':btemp}) %}
#     {% endif %}
#   {% endfor %}

#   {# Count and choose bed temp #}
#   {% set count = used|length %}
#   {% set bed_fallback = (params.BED_TEMP|default(printer["gcode_macro JOB_SUMMARY"].default_bed))|float %}
#   {% if count <= 1 %}
#     {% if count == 1 %}
#       {% set only = per_tool[0] %}
#       {% set BED = (only.btemp|float if only.btemp is not none else bed_fallback) %}
#     {% else %}
#       {% set BED = bed_fallback %}
#     {% endif %}
#   {% else %}
#     {% set BED = (bed_list|max if bed_list else bed_fallback) %}
#   {% endif %}

#   {# Chamber (optional) and initial tool for display #}
#   {% set CHAMBER = (params.CHAMBER|default(0))|int %}
#   {% set INIT = (params.TOOL_INIT|default(0))|int %}

#   RESPOND_INFO "===== Job Summary ====="
#   RESPOND_INFO "Tools used: {{count}} {% if count>0 %}({{ used | map('string') | join(', ') | replace('0','T0') | replace('1','T1') | replace('2','T2') | replace('3','T3') | replace('4','T4') | replace('5','T5') }}){% endif %}"
#   RESPOND_INFO "Chosen bed temp: {{ '%.0f'|format(BED) }} °C  | Chamber: {{CHAMBER}} °C"
#   {% for row in per_tool %}
#     RESPOND_INFO "T{{row.i}}  MAT={{row.mat}}  Tool={{row.ttemp}}°C  Idle={{row.idle}}°C  BedReq={{ row.btemp if row.btemp is not none else '—' }}"
#   {% endfor %}
#   RESPOND_INFO "Initial tool: T{{INIT}}"
#   RESPOND_INFO "======================="

#   M117 T{{count}} bed {{ '%.0f'|format(BED) }}°  ch {{CHAMBER}}°
